pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
--cyberpunk 1877
--by thearchitect
function _init()
	cls();
	map(0,0);
	framecount=0;
	jumpantighost=0;
	jp_h=0;
	jp_allow=true;
	init_player();
end

function _update()
	fps=stat(7);
	framecount+=1;
	reset_player();
	--first check collistion and
	--update phyiscal status
	--if we have hpâ™¥,we also update
	--it here.
	standing=_getstandable(player.x,player.y);
	_updatejump()
	if player.dy==0 then
		--this is kind of hack,
		--make sure player landing on
		--quantized height
		player.y=(round(player.y/8))*8;
	end
	
	--then we update the input info
	--currenty, it update play data
	--however, in better implemttation
	--input update speed, then location
	--is updated in previous section.
	_updateinput()
end

function _draw()
	cls();
	--after update the status
	--we update the graphics
	_drawmap();
	_drawplayer();
end
-->8
--player/actor struct
function reset_player()
	player.moving=false;
	--player.goingleft=false;not reset this
	player.onland=true;
end

function init_player()
	player={}
	player.x=24;//pos_x
	player.y=96;//pos_y
	player.walkv=1;//speed_x
	player.runv=2;//speed_x
	player.dy=0;//speed_y
	player.g=1;//falling speed
	player.jumpv=3;
	player.jumph=5;
	/////////////
	player.spid=2;
	player.spidm0=4;
	player.spidm1=5;
	player.spidmair=3;
	/////////////
	player.moving=false;
	player.goingleft=false;
	player.onland=true;
	return player;
end
-->8
--io/movement manager
function _getstuck(px,py)
	local num=mget(flr(px/8),flr(py/8));
	local flag=(fget(num)==16);
	return flag;
end

function _getstandable(px,py)
	local num=mget(flr(px/8),flr((py+12)/8));
	local flag=(fget(num)==16);
	return flag;
end

function _updatejump()
	if player.dy<0 then 
		jp_h+=1;
	end
	if (not standing) and player.dy==0 then
		player.dy+=player.g;
	elseif (jp_h>=player.jumph) or (not jp_allow) then
		jp_allow=false;
		jp_h=0;
		player.dy+=player.g;
	end
	
	inair=(not standing);
	if not inair then
		jp_allow=true;
		player.dy=min(player.dy,0);
		jp_h=0;
	end
	player.y+=player.dy;
end

function _updateinput()
	if (btn(4) and jp_h<player.jumph) and jp_allow then
		player.dy=(-player.jumpv);
		jp_h+=1;
	end
	if btn(0) then 
		player.x-=player.walkv;
		player.moving=true;
		player.goingleft=true;
	end
	if btn(1) then 
		player.x+=player.walkv;
		player.moving=true;
		player.goingleft=false;
	end
end
-->8
--graphic manager
function _drawmap()
 map(0,0);
end

function _drawplayer()
	local sfc=flr(framecount/2);
	local _spid=player.spid;
	if not player.onland then
		_spid=player.spidmair;
	elseif player.moving then
		if sfc%2==0 then
			_spid=player.spidm0;
		else
			_spid=player.spidm1;
		end
	end
	if player.goingleft then
		_spid+=16;
	end
	spr(_spid,player.x,player.y);
end
-->8

-->8

-->8
--utils
function round(x)
	local delta=x-flr(x);
	if delta<0.5 then
		return flr(x);
	else
	 return flr(x)+1;
	end
end
-->8
--data sheet
--sprit flag:
--00000000 nothing
--10000000 player
--01000000 npc
--11000000 enemy
--00100000
--10100000
--01100000
--11100000
--00010000
--10010000
--01010000
--11010000
--00110000
--10110000
--01110000
--11110000
----------budlding section
--00001000 standable
__gfx__
00000000077777700022220000222200002222000022220000222200002222000022220000222200002222004aaaaaa4a0a0a000000000004444444400000000
00000000071c1c700222222002222220022222200222222002222220022222200222222002222220022222209444444d0aaa0000000000004454444400000000
00700700071c1c7000f1f10000f1f10000f1f10000f1f100001f1f00001f1f00001f1f00001f1f00001f1f009444444d00300000000000004454444400000000
000770000711117000ffff0000ffff0000ffff0000ffff0000ffff0000ffff0000ffff0000ffff0000ffff009444444db0300000000099904444444400000000
0007700007777770065494f0065494f0065494f0065494f0064945f0064945f0064945f0064945f0064945f09444444d3b30b000000033304444445400000000
0070070000600600065545f06055450f066545f0065545f0065455f06054550f0654550f06545ff0065455f09444444d033b30000000b3b04444445400000000
00000000006006000011110000111100001111000011110000111100001111000011110000111100001111009444444d00330000000003004445444400000000
000000000066066000f00f000f0000f00f000f0000f000f000f00f000f0000f00f000f0000f000f000f00f0040000004b3b3b3b33b3b3b3b444444443b3b3b3b
00000000000000000022220000222200002222000022220000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000222222002222220022222200222222000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000001f1f00001f1f00001f1f00001f1f0000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000ffff0000ffff0000ffff0000ffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000064945f0064945f0064945f0064945f000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000077770000000065455f06054550f06545ff00654550f00000000000000000000000000000000000000000000000000000000000000000000000000000000
00077777770000000011110000111100001111000011110000000000000000000000000000000000000000000000000000000000000000000000000000000000
007777767770777000f00f000f0000f000f000f00f000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777776677777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777776777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
76677777666666770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
76666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06666660000066660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00066000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0002010101010000000000100000100000000101010100000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000001011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000002021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0f0f0d0c0f0f0f0f0c0d0f0b0b0b0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
00010000000000000000000000001705018050000001a0501d0501f0502205025050280502a0502e0503205030050290502005019050170501505013050100500f0500e050000000000000000000000000000000
001000001625017750177501425021e5015e501f150138501105014050180501b0501e050200501b0500f0500e0501235016350193501b3501d35021350095500c5500c55010550195500c350113501a35010350
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000017150181501a150000001b150000001c1501e15000000201502215024150251502615027150281502a1502b150000002d1502f150000003015031150311502f1502d15027150241500000000000
__music__
00 01434344

